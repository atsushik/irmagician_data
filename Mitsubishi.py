#!/usr/bin/env python
# -*- coding: utf-8 -*-

import json
import sys
from optparse import OptionParser

# class Mitsubishi():
class MSZ_GV2216():
    # print modes
    def get_ir_data(self, mode, temperature, wind, louver, clean, powerful, postscale=100):
# MSZ-GE5616S
#mode 温 風 風 パ 清                                                                                                                         清          パ
#mode 度 量 向 ワ 潔                                        ヘッダ        機能 温度       機能２ 風量角度                                    潔          ワ             checksum
#除湿     1 自  0  0 110001001101001101100100100000000000000000000 10000001010 0001 000001001100 100 0001 00000000000000000000000000000000000 0 000000000 0 00000000000 00000000
#除湿     2 自  0  0 110001001101001101100100100000000000000000000 10000001010 0001 000001001100 010 0001 00000000000000000000000000000000000 0 000000000 0 00000000000 10000000
#除湿     3 自  0  0 110001001101001101100100100000000000000000000 10000001010 0001 000001001100 110 0001 00000000000000000000000000000000000 0 000000000 0 00000000000 01000000
#除湿    強 自  0  0 110001001101001101100100100000000000000000000 10000001010 0001 000001001100 110 0001 00000000000000000000000000000000000 0 000000000 1 00000000000 01001000
#除湿     3 自  0  1 110001001101001101100100100000000000000000000 10000001010 0001 000001001100 000 0001 00000000000000000000000000000000000 1 000000000 0 00000000000 11000000
#送風    自 自  0  1 110001001101001101100100100000000000000000000 10000011100 0001 000000001100 000 0001 00000000000000000000000000000000000 1 000000000 0 00000000000 10010111
#                    110001001101001101100100100000000000000000000 10000011000 1101 000001101100 110 1001 00000000000000000000000000000000000 0 000000000 1 00000000000
# MSZ-GV2216(W)
#mode 温 風 風 パ 清                                                                                                                         清          パ
#mode 度 量 向 ワ 潔                                        ヘッダ        機能 温度       機能２ 風量角度                                    潔          ワ             checksum
#cool 16  2  0       110001001101001101100100100000000000000000000 10000011000 0000 000001101100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 10001011
#cool 17  2  0       110001001101001101100100100000000000000000000 10000011000 1000 000001101100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 01001011
#cool 31  2  0       110001001101001101100100100000000000000000000 10000011000 1111 000001101100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 00000111
#cool 27 自 自       110001001101001101100100100000000000000000000 10000011000 1101 000001101100 000 0001 00000000000000000000000000000000000 0 000000000 1 00000000000 01111011
#cool 27 自 自     1 110001001101001101100100100000000000000000000 10000011000 1101 000001101100 000 0001 00000000000000000000000000000000000 1 000000000 1 00000000000 01000111
#除湿強   2  0       110001001101001101100100100000000000000000000 10000001000 0001 000000001100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 11010011
#除湿弱   2  0       110001001101001101100100100000000000000000000 10000001000 0001 000000101100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 11110011
#除湿     2  0       110001001101001101100100100000000000000000000 10000001000 0001 000001001100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 10110011
#除湿    自 自  1    110001001101001101100100100000000000000000000 10000001000 0001 000001001100 000 0001 00000000000000000000000000000000000 0 000000000 1 00000000000 11110011
#off                 110001001101001101100100100000000000000000000 00000010000 1110 000000001100 010 0001 00000000000000000000000000000000000 1 000000000 0 00000000000 01011001
#warm 16  2  0       110001001101001101100100100000000000000000000 10000010000 0000 000000001100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 11011101
#warm 17  2  0       110001001101001101100100100000000000000000000 10000010000 1000 000000001100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 00111101
#warm 23 自 自       110001001101001101100100100000000000000000000 10000010000 1110 000000001100 000 0001 00000000000000000000000000000000000 1 000000000 0 00000000000 00011101
#warm 23  1 自       110001001101001101100100100000000000000000000 10000010000 1110 000000001100 100 0001 00000000000000000000000000000000000 1 000000000 0 00000000000 10011101
#warm 23  2 自       110001001101001101100100100000000000000000000 10000010000 1110 000000001100 010 0001 00000000000000000000000000000000000 1 000000000 0 00000000000 01011101
#warm 23  3 自       110001001101001101100100100000000000000000000 10000010000 1110 000000001100 110 0001 00000000000000000000000000000000000 1 000000000 0 00000000000 11011101
#warm 23  2 自       110001001101001101100100100000000000000000000 10000010000 1110 000000001100 010 0001 00000000000000000000000000000000000 1 000000000 0 00000000000 01011101
#warm 23  2  0       110001001101001101100100100000000000000000000 00000010000 1110 000000001100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 01000101
#warm 23  2  1       110001001101001101100100100000000000000000000 10000010000 1110 000000001100 010 0101 00000000000000000000000000000000000 1 000000000 0 00000000000 01010011
#warm 23  2  2       110001001101001101100100100000000000000000000 10000010000 1110 000000001100 010 1101 00000000000000000000000000000000000 1 000000000 0 00000000000 01001011
#warm 23  2  3       110001001101001101100100100000000000000000000 00000010000 1110 000000001100 010 0011 00000000000000000000000000000000000 1 000000000 0 00000000000 01011101
#warm 23  2  4       110001001101001101100100100000000000000000000 10000010000 1110 000000001100 010 1011 00000000000000000000000000000000000 1 000000000 0 00000000000 01000111
#warm 23  2 全 　　　110001001101001101100100100000000000000000000 10000010000 1110 000000001100 010 1111 00000000000000000000000000000000000 1 000000000 0 00000000000 01001111
#warm 31  2  0       110001001101001101100100100000000000000000000 10000010000 1111 000000001100 010 1001 00000000000000000000000000000000000 1 000000000 0 00000000000 01010011

        data = {}
        data['postscale'] = postscale
        data['freq']      = 38
        data['format']    = 'raw'
        data['data']      = []

        header       = [120, 53, 24, 7] # データの送信前に送信される信号
        data_delta   = [190, 53, 24, 7] # 同じデータが２回送信されるときにその間で送信される信号
        on_duration  = 18
        off_duration = 5

        data['data'] += header

        modes = {
            "wind"             :"10000011100",
            "cool"             :"10000011000",
            "dehumidify_strong":"10000001000",
            "dehumidify_weak"  :"10000001000",
            "dehumidify"       :"10000001000",
            "warm"             :"10000010000",
            "off"              :"00000010000",
        }
        modes2 = {
            "wind"             :"000000001100",
            "cool"             :"000001101100",
            "dehumidify_strong":"000000001100", # 除湿 強
            "dehumidify_weak"  :"000000101100", # 除湿 弱
            "dehumidify"       :"000001001100", # 除湿
            "warm"             :"000000001100",
            "off"              :"000000001100",
        }
        winds = {
            "Auto": 0,
            "1"   : 1,
            "2"   : 2,
            "3"   : 3,
        }
        louvers = {
            "Auto": 0,
            "0"   : 1,
            "1"   : 2,
            "2"   : 3,
            "3"   : 4,
            "4"   : 5,
            "All" : 7,
        }
        powerful_flag = {
            "0"   : "0",
            "1"   : "1",
            "off" : "0",
            "on"  : "1",
        }
        clean_flag = {
            "0"   : "0",
            "1"   : "1",
            "off" : "0",
            "on"  : "1",
        }

        command_header      = "110001001101001101100100100000000000000000000"
        command_mode        = modes[mode]
        command_temperature = format(int(temperature) - 16, '04b')[::-1]
        command_mode2       = modes2[mode]
        command_wind        = format(winds[wind],      '03b')[::-1]
        command_louver      = format(louvers[louver],  '03b')[::-1] + "1"
        command_footer0     = "00000000000000000000000000000000000"
        command_clean       = clean_flag[clean]
        command_footer1     = "000000000"
        command_powerful    = powerful_flag[powerful]
        command_footer2     = "00000000000"
        #
        bin_command =  command_header + command_mode + command_temperature + command_mode2 + command_wind + command_louver + command_footer0 + command_clean + command_footer1 + command_powerful + command_footer2
        #
        sum = 0
        while len(bin_command) > 0:
            b = bin_command[:8]
            i = int(b[::-1], 2)
            sum += i
            bin_command = bin_command[8:]
        checksum = format(sum, '0b')
        checksum = checksum[::-1][:8] # 逆順にして８桁までにする
        #print command_header, command_mode, command_temperature, command_mode2, command_wind, command_louver, command_footer + checksum
        bin_command =  command_header + command_mode + command_temperature + command_mode2 + command_wind + command_louver + command_footer0 + command_clean + command_footer1 + command_powerful + command_footer2
        bin_command += checksum
        #
        # sys.stderr.write(u"mode:%s , temperature:%s , wind:%s , louver:%s\n" % (mode, temperature, wind, louver))
        #sys.stderr.write(bin_command + "\n")
        #sys.stderr.write("|-------------------------------------------||---------||--||----------||-||--||-------------------------------------------------------||------|\n")
        #sys.stderr.write("                   HEADER                        MODE          MODE2    WIND                       UNKNOWN                              checksum\n")
        #sys.stderr.write("                                                     TEMPERATURE          LOUVER\n")

        header       = [120, 53, 24, 7]
        data_delta   = [190, 53, 24, 7]
        one_duration  = 18
        zero_duration = 5
        off_duration  = 7

        data['data'] += header
        for b in bin_command:
            if b == '0':
                data['data'] += [zero_duration, off_duration]
            elif b == '1':
                data['data'] += [one_duration,  off_duration]
        data['data'] += data_delta
        for b in bin_command:
            if b == '0':
                data['data'] += [zero_duration, off_duration]
            elif b == '1':
                data['data'] += [one_duration,  off_duration]
        if not data['postscale'] == 100:
            tmp = []
            for d in data['data']:
                tmp.append(d * (100 / data['postscale']))
            data['data'] = tmp
        data['mode'] = mode
        data['temperature'] = temperature
        data['wind'] = wind
        data['louver'] = louver
        data['clean'] = clean

        # sys.stderr.write( json.dumps(data) )
        return json.dumps(data)

